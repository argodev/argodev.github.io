<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Rob Gillen</title><link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Montserrat:400,700"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,700"><link rel="stylesheet" href="/assets/site.css"><link rel="stylesheet" href="/assets/academicons.css"></head><body><div id="wrap"><div class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Rob Gillen</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/technology">Technology</a></li><li><a href="/presentations">Talks</a></li><li><a href="/papers">Publications</a></li><li><a href="/projects">Projects</a></li><li><a href="/personal">Personal</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li><!--li.dropdown--><!--  a.dropdown-toggle(href="#", data-toggle="dropdown") Dropdown <b class="caret"></b>--><!--  ul.dropdown-menu--><!--    li--><!--      a(href="#") Action--><!--    li--><!--      a(href="#") Another action--><!--    li--><!--      a(href="#") Something else here--><!--    li.divider--><!--    li.dropdown-header Nav header--><!--    li--><!--      a(href="#") Separated link--><!--    li--><!--      a(href="#") One more separated link--></ul></div></div></div><div class="container"><div class="page-header"><h1 class="entry-title">“Live” Monitoring Of Your Worker Roles in Azure</h1></div><div class="row"><div class="col-md-9"><div class="panel"><div class="panel-body"><div class="row"><div class="col-md-12"><h5>September 3, 2009</h5><p><img alt="Gauges" src="/assets/images/image_7274FE9B.png" class="blogimage img-responsive"></p>
<p>I’ve been working for a bit on some larger-scale jobs targeting the Windows Azure platform and early last week had
assembled a collection of worker roles that were supposed to be processing my datasets for a number of days moving
forward. Unfortunately, they wouldn’t stay running. As always, they “worked on my machine”, so I naturally assumed that
the problem was with the Azure platform :). I then proceeded to do what I thought was the correct action… go to the
Azure portal and request that the logs be transferred to my storage account so I could review them and fix the problem.
What I learned, is that there were two problems with this solution:</p>
<ol>
<li><p>The time delay between requesting the logs and actually being able to review them is prohibitive for productive use.
In my experience, the minimum turn around was 20 minutes and was most often 30 or longer. I’m not sure why this was
happening – is this by design, or a temporary bug, or an artifact of the actual problem with my code, or what, but I
know it was too long.</p>
</li>
<li><p>Logs appear to get “lost”. In my scenario, my worker roles were throwing an exception that was un-caught my by code.
Near as I can tell, when this happens, the Azure health monitoring platform assumes that the world has come to an end,
shuts down that instance, and spins a new instance. While this (health monitoring and auto-recovery) is a good thing,
one side effect (<em>caveat is the fact that this is my experience and may not be reality</em>) is that the logs were stored
locally and, when the instance was shutdown/recycled, those log files went to the great bit-bucket in the sky. I was
stuck in a failure mode with no visibility as to what was going wrong nor how to fix it.</p>
</li>
</ol>
<p>After pounding my head for a bit, I came up with the following solution – trap every exception possible and use queues.
The first aspect allowed my worker roles to stay running. This may not always be the right answer, but for my use case,
I adapted my code to handle the error cases and trapping / suppressing all exceptions proved to be a good answer.
Further, doing so allowed me to grab the error message and do something interesting with it.</p>
<p>The second step (using queues) solved the (my) impatience problem. I created a local method called WriteToLog that did
two things: write to the regular Azure log, and write to a queue I created called status (or something similarly
brilliant). I replaced all of my <code>RoleManager.WriteToLog()</code> calls with calls to the local method and I then wrote a
console app that would periodically (every few seconds) pop as many messages as it could (API-limited to 32) off of the
status queue, dump the data as a local csv for logging and write the data to the screen. This allowed me to drastically
reduce the feedback loop between my app and me, enabling me to fix the problems quickly.</p>
<p>There are certainly some downsides to this approach (do queues hit a max?, what is the overhead introduced by logging
to a queue, once a message is dequeued, it is not available for other clients to read, etc), but it was a nice spot fix.
A better implementation would have a flag in the config file or something similar that would control the queue-logging.</p>
<p>As you can see from the image above, I also wrote a little winform app to display the approximate queue length so I’d
have an idea of the progress and how much work remained.</p><!--a(href='#{ conf.web_link }') Conference Homepage--><!--each session in conf.sessions--><!--  .row--><!--    .col-xs-11--><!--      h4 #{ session.title }--><!--      p #{ session.abstract }--><!--      if session.assets--><!--        ul--><!--          each asset in session.assets--><!--            li--><!--              a(href='#{ asset.link }') #{ asset.title }--></div></div><hr><div id="disqus_thread"></div></div></div></div><div class="col-sm-3"><div class="panel panel-default"><div class="panel-heading">Recent Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/fighting_with_hidden_characters">Fighting with Hidden Characters</a></li><li><a href="/technology/2014/you-cant-handle-the-truth">You Can't Handle The Truth</a></li><li><a href="/technology/2014/codestock-2014">CodeStock 2014</a></li><li><a href="/technology/2014/tracking-planes-on-vacation">Tracking Planes on Vacation</a></li><li><a href="/technology/2014/book-review-learning-windows-mobile-services-for-win-8-and-win-phone-8">Book Review: Learning Windows Mobile Services for Win 8 and Win Phone 8</a></li><li><a href="/technology/2014/codemash-2014">CodeMash 2014</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading">Older Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/">2015 Posts</a></li><li><a href="/technology/2014/">2014 Posts</a></li><li><a href="/technology/2013/">2013 Posts</a></li><li><a href="/technology/2012/">2012 Posts</a></li><li><a href="/technology/2011/">2011 Posts</a></li><li><a href="/technology/2010/">2010 Posts</a></li><li><a href="/technology/2009/">2009 Posts</a></li><li><a href="/technology/2008/">2008 Posts</a></li><li><a href="/technology/2007/">2007 Posts</a></li><li><a href="/technology/2006/">2006 Posts</a></li><li><a href="/technology/2005/">2005 Posts</a></li><li><a href="/technology/2004/">2004 Posts</a></li></ul></div></div></div></div></div></div><div id="footer"><div class="container"><p class="text-muted credit"><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a> This work is licensed under a<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"> Creative Commons Attribution 4.0 International License</a>.</p></div></div><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script><script type="text/javascript" src="/assets/site.js"></script></body></html>