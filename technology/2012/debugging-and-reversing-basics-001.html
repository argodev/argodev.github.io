<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Rob Gillen</title><link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"><link rel="stylesheet" href="/assets/site.css"><link rel="stylesheet" href="/assets/academicons.css"></head><body><div id="wrap"><div class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Rob Gillen</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/technology">Technology</a></li><li><a href="/presentations">Presentations/Talks</a></li><li><a href="/papers">Publications/Arcticles</a></li><li><a href="/projects">Projects</a></li><li><a href="/personal">Personal</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li><!--li.dropdown--><!--  a.dropdown-toggle(href="#", data-toggle="dropdown") Dropdown <b class="caret"></b>--><!--  ul.dropdown-menu--><!--    li--><!--      a(href="#") Action--><!--    li--><!--      a(href="#") Another action--><!--    li--><!--      a(href="#") Something else here--><!--    li.divider--><!--    li.dropdown-header Nav header--><!--    li--><!--      a(href="#") Separated link--><!--    li--><!--      a(href="#") One more separated link--></ul></div></div></div><div class="container"><div class="page-header"><h1>Debugging and Reversing Basics 0.01</h1></div><div class="row"><div class="col-md-9"><div class="panel"><div class="panel-body"><div class="row"><div class="col-md-12"><h5>October 15, 2012</h5><p><small>[Note: the title is what it is because I consider myself a n00b at this and these are likely things anyone else
already knows]</small></p>
<p>I&#39;m always trying to learn more and recently topics in the infosec world have garnered my attention. To further my
understanding of the space, I&#39;ve been reading a bit and this weekend was reading part of <a href="http://www.amazon.com/gp/product/B007V2DNEK/ref=as_li_ss_tl?ie=UTF8&amp;camp=1789&amp;creative=390957&amp;creativeASIN=B007V2DNEK&amp;linkCode=as2&amp;tag=robgillenblog-20">Gray Hat Python: Python
Programming for Hackers and Reverse Engineers</a>
and found myself purposefully doing that which you shouldn&#39;t do when
learning a new subject: <strong><em>not following the instructions</em></strong>. You see, the author specifically indicates that the samples
were written on/tested on a Windows x86 machine and his assumption is that you will be running on the same. In my case,
I haven&#39;t run a 32-bit OS in years (since Vista was released) and I made two assumptions: 1.) It probably doesn&#39;t
matter that much and 2.) even if it does, it&#39;s probably a good thing to learn what the differences b/t 32 and 64 bit
debugging/reversing are. Well, after a few hours of playing around, I can tell you the first assumption was flat wrong
and the second is probably accurate.</p>
<p>The fun beings in chapter 3 where you build a simple debugger. I got stuck on the very first step which was a simple
demonstration of attaching to an existing process (calc.exe). I would run the script and simply get an error: <code>[*]
Unable to attach to the process.</code> I figured I must have done something wrong, so I poked around a bit and even diff&#39;d
my code against the reference and still didn&#39;t see any important differences. *As a side note: If you&#39;ve not yet <a href="http://nostarch.com/index.php?q=ghpython.htm#updates">looked
at the errata for the book</a>, <strong>you need to do so</strong>. There are a
number of code/bug fixes that are required to get things working.</p>
<p>The key came from a <a href="http://wordgems.wordpress.com/2010/12/18/gray-hat-python/">blog post I came across written by A. H.</a>
where he hints that the problem may have to do with the architecture of the application I am attempting to attach to. He
suggests adjusting the error line in the script as follows:</p>
<pre><code>print &quot;[*] Unable to attach to the process. %s&quot; %
    FormatError(kernel32.GetLastError())
</code></pre><p>and if the error ends with &quot;The request is not supported&quot; you can rest sure that your problem is a 32/64 bit issue.
Unfortunately, A.H.&#39;s solution was to simply use a 32-bit box for the rest of the testing.</p>
<h3>What Version of Python am I running?</h3><p>The next issue that occured to me was to determine which version of Python (bit-ness) I was running. I simple search
brought up <a href="http://stackoverflow.com/questions/1405913/how-do-i-determine-if-my-python-shell-is-executing-in-32bit-or-64bit-mode">Ned Deily&#39;s answer on Stack Overflow</a>
which indicated that one simple way to check would be to run the following:</p>
<pre><code>python -c &quot;import struct;print( 8 * struct.calcsize(&#39;P&#39;))&quot;
</code></pre><p>You will get either 32 or 64 as a result - in my case, 32. Great. So I know that my debugging thread is a 32-bit
application, what is the image type of calc.exe?</p>
<h3>DumpBin</h3><p>Some poking around led me to an article by <a href="http://blogs.technet.com/b/windowshpc/archive/2009/03/27/how-to-tell-if-a-exe-file-is-a-32-bit-or-64-bit-application-using-dumpbin.aspx">Frank Chism on the Windows HPC blog</a>
that pointed to being able to run a tool called dumpbin to see if an exe was 32 or 64 bit. I followed the instructions
on his post, opened a VS 2010-enabled command shell and typed the following:</p>
<pre><code>dumpbin /headers c:\Windows\system32\calc.exe|findstr &quot;magic machine&quot;
</code></pre><p>Which resulted in:</p>
<pre><code>14C machine (x86)
    32 bit word machine
10B magic # (PE32)
</code></pre><p>Ok... so my debugging thread is 32-bit, and the executeable that I&#39;m running is 32-bit, so why am I unable to attach to
the thread?</p>
<h3>Process Explorer</h3><p>At this point, I pulled up the trusty Sys Internals Process Explorer to see if it would shed any light on the issue.
From within Process Monitor, if you select the View menu and then click on &quot;Select Columns&quot; you can tick the box for
&quot;Image Type&quot; which will allow you to see for each process/executeable running what the image type is. And, after quickly
checking, I see that calc.exe is running as a 64-bit image. How in the world is this happening?</p>
<h3>WOW64</h3><p>64 Bit Windows has a feature called the <a href="http://msdn.microsoft.com/en-us/library/aa384187%28VS.85%29.aspx">File System Redirector</a>
which seems to be the root of my issues. If I understand how this works (dubious), this is a layer within the OS that
&quot;magically&quot; redirects you to the proper version of the application based on the calling process. For example, if a
64-bit process attempts to open the 64-bit image of calc.exe (located in <code>C:\Windows\System32</code>), it will work just
fine. However, if a 32-bit process attempts to do the same thing, it will get magically re-directed to the 32-bit
version of the application which is located in <code>C:\Windows\SysWOW64</code> (don&#39;t even ask why the folders are named the way
they are based on the versions of the applications that they house). What this means, is that if you simply hit
Windows+R and type calc, you are calling it from a 64-bit process (the shell) and therefore you get the 64-bit version
of the application. If, however, you reference calc.exe from a 32-bit process (i.e. dumpbin), you get redirected to the
32-bit version.</p>
<p>If you specifically need the 32-bit version (as I did to complete my testing), you can open a command prompt, navigate
to <code>c:\Windows\SysWOW64</code> and then type <code>calc.exe</code> or, you can have it launched from any 32-bit process. To see this
second option in action, open a command prompt, navigate to <code>c:\windows\SysWOW64</code> and then type <code>cmd.exe</code>. Via Process
Explorer you can confirm that you are running a 32-bit version of cmd.exe. Then navigate wherever you&#39;d like
(i.e. <code>c:\</code>) and then type <code>calc.exe</code>. You will now get the 32-bit version of the application (and can confirm it in
Process Explorer).</p>
<p>From here, I can attach to the process (calc.exe as 32-bit) from my python code. This moves me forward a bit but
doesn&#39;t solve the &quot;how do I bind to the 64-bit image&quot; question. That will be a problem for another day.</p><!--a(href='#{ conf.web_link }') Conference Homepage--><!--each session in conf.sessions--><!--  .row--><!--    .col-xs-11--><!--      h4 #{ session.title }--><!--      p #{ session.abstract }--><!--      if session.assets--><!--        ul--><!--          each asset in session.assets--><!--            li--><!--              a(href='#{ asset.link }') #{ asset.title }--></div></div><hr><div id="disqus_thread"></div></div></div></div><div class="col-sm-3"><div class="panel panel-default"><div class="panel-heading">Recent Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/fighting_with_hidden_characters">Fighting with Hidden Characters</a></li><li><a href="/technology/2014/you-cant-handle-the-truth">You Can't Handle The Truth</a></li><li><a href="/technology/2014/codestock-2014">CodeStock 2014</a></li><li><a href="/technology/2014/tracking-planes-on-vacation">Tracking Planes on Vacation</a></li><li><a href="/technology/2014/book-review-learning-windows-mobile-services-for-win-8-and-win-phone-8">Book Review: Learning Windows Mobile Services for Win 8 and Win Phone 8</a></li><li><a href="/technology/2014/codemash-2014">CodeMash 2014</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading">Older Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/">2015 Posts</a></li><li><a href="/technology/2014/">2014 Posts</a></li><li><a href="/technology/2013/">2013 Posts</a></li><li><a href="/technology/2012/">2012 Posts</a></li><li><a href="/technology/2011/">2011 Posts</a></li><li><a href="/technology/2010/">2010 Posts</a></li><li><a href="/technology/2009/">2009 Posts</a></li><li><a href="/technology/2008/">2008 Posts</a></li><li><a href="/technology/2007/">2007 Posts</a></li><li><a href="/technology/2006/">2006 Posts</a></li><li><a href="/technology/2005/">2005 Posts</a></li><li><a href="/technology/2004/">2004 Posts</a></li></ul></div></div></div></div></div></div><div id="footer"><div class="container"><p class="text-muted credit"><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a> This work is licensed under a<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"> Creative Commons Attribution 4.0 International License</a>.</p></div></div><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script><script type="text/javascript" src="/assets/site.js"></script></body></html>