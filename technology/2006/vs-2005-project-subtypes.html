<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Rob Gillen</title><link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"><!--link(rel="stylesheet", href='http://fonts.googleapis.com/css?family=Montserrat:400,700')--><!--link(rel="stylesheet", href='http://fonts.googleapis.com/css?family=PT+Sans:400,700')--><link rel="stylesheet" href="/assets/site.css"><link rel="stylesheet" href="/assets/academicons.css"></head><body><div id="wrap"><div class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Rob Gillen</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/technology">Technology</a></li><li><a href="/presentations">Talks</a></li><li><a href="/papers">Publications</a></li><li><a href="/projects">Projects</a></li><li><a href="/personal">Personal</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li><!--li.dropdown--><!--  a.dropdown-toggle(href="#", data-toggle="dropdown") Dropdown <b class="caret"></b>--><!--  ul.dropdown-menu--><!--    li--><!--      a(href="#") Action--><!--    li--><!--      a(href="#") Another action--><!--    li--><!--      a(href="#") Something else here--><!--    li.divider--><!--    li.dropdown-header Nav header--><!--    li--><!--      a(href="#") Separated link--><!--    li--><!--      a(href="#") One more separated link--></ul></div></div></div><div class="container"><div class="page-header"><h1 class="entry-title">VS 2005 Project Subtypes</h1></div><div class="row"><div class="col-md-9"><div class="panel"><div class="panel-body"><div class="row"><div class="col-md-12"><h5>June 15, 2006</h5><p>I’ve had the opportunity lately to work on a project that needed to generate some code for a project based on a given
file within the project and then include/add those files to the project for inclusion during build. We spent a good bit
of time looking at the various options such as custom MSBuild tasks, add-ins, VSPackages, etc. and finally settled on a
Visual Studio Package that implemented a project subtype, a custom project property page, and a custom tool
(single-file generator).</p>
<p>The documentation in the VS 2005 SDK continues to improve as does the general toolset. For those of you who aren’t
aware, the SDK team has moved to a very aggressive release schedule posting new builds every few months in the
CTP/RTM model. Of particular note has been the improvements to the managed package framework - MPF (no, not Microsoft
provisioning framework). These improvements have made it possible for non-C++ aficionados such as myself to write some
interesting tools fully integrated into the platform.</p>
<p>I used the <code>ProjectSubType</code> sample (installed by default to
<code>C:\Program Files\Visual Studio 2005 SDK\2006.04\VisualStudioIntegration\Archive\CS_Samples\ProjectSubtype\ProjectSubtype</code>)
provided in the SDK as my guide for much of the features I needed to implement. I encountered a few “gotchas” along the
way (thanks to those who lent support) and I am going to document them here for my own sake (easy to find in the future)
as well as maybe helping others who find themselves hitting the same issues. In this post I’ll cover a few of the items
I hit and I’ll cover some others in subsequent posts.</p>
<p>Creating a project sub-type seemed incredibly easy… simply modify/include the files I wanted in a
<code>/templates/projects</code> directory (this really can be anywhere so long as the path is properly registered for your
package in the registry) and I was ready to go. The SDK documentation is really pretty clear on this and you will find
yourself with a custom project (in my case a flavor of a C# class library) in no time at all.</p>
<p>The first place where things got a little hairy was the custom properties page. I actually took the samples from the
<code>ProjectSubType</code> project and had a custom page in no time, however it had one major drawback as it related to my
project – the properties it saved were configuration specific (i.e. debug/release) rather than being configuration
ambivalent as I wanted. I spent some time fighting through things and finally ended up doing the following…</p>
<ol>
<li><p>On my project sub-type (project.cs) I implemented the <code>IPersistXMLFragment</code> interface nearly identically from the SDK
sample documents. The only thing I did differently is that I did not pass the request on to other project sub-types (I
don’t intend for anyone to sub-type my project).</p>
</li>
<li><p>I created an interface (say <code>IMyCustomProperties</code>) that defined accessors for the properties I wanted to expose and
then implemented the interface on my flavored project (<code>project.cs</code>).</p>
</li>
<li><p>The default sample shows (in the implementation of <code>IVsHierarchy</code>) the <code>GetProperty</code> method removing one property
page and then adding another. What I learned, is that the case branch in which they remove a property page
(<code>__VSHPROPID2.VSHPROPID_PropertyPagesCLSIDList</code>) is actually where you want to add your page if you want it to appear
and be configuration independent. As in the following…</p>
</li>
</ol>
<pre><code>protected override int GetProperty(uint itemId, int propId, out object property)
{
    switch (propId)
    {
        case (int)__VSHPROPID2.VSHPROPID_PropertyPagesCLSIDList:
        {
            // Get the list from the base class
            ErrorHandler.ThrowOnFailure(base.GetProperty(itemId, propId,
                out property));

            // Add our WES Property Page
            Debug.Assert(typeof(IPropertyPage).IsAssignableFrom(
                typeof(MyPropertyPage)),
                &quot;Property page should implement IPropertyPage&quot;);

            property += &#39;;&#39; + typeof(MyPropertyPage).GUID.ToString(&quot;B&quot;);
            //property = propertyPagesList;
            return VSConstants.S_OK;
        }
    }

    return base.GetProperty(itemId, propId, out property);
}
</code></pre><p>Where <code>MyPropertyPage</code> is a local class that inherits from <code>PropertyPageBase.PropertyPage</code> (provided as shared-source
in the SDK).</p>
<p>The item I struggled with for quite some time was the implementation of <code>MyPropertyStore</code> – a class for interacting
with the data store and implementing <code>PropertyPageBase.IPropertyStore</code>. The sample project implements this file,
however it is once again interacting with configuration-specific data and the way in which it retrieves the main
“data object” (casting the data object in the <code>Initialize()</code> method as <code>IVsCfg</code>). NOTE: The <code>Initialize()</code> method is
called by the <code>SetDataObjects()</code> method that is implemented in the <code>PropertyPageBase.PropertyPage</code> class. I knew that
what I really wanted was to get the <code>IMyCustomProperties</code> interface from my project object so I could access my custom
properties. I tried a <code>QueryInterface</code> on the data variable using all sorts of classes and interfaces and was patently
unsuccessful until someone pointed me in the correct path… the proper procedure when using project-based properties is
to cast the object as an <code>IVsBrowseObject</code> first, and then you can call <code>GetProjectItem</code> to retrieve the <code>IVsHierarchy</code>
object, from which you can finally obtain the custom interface you wanted…</p>
<pre><code>void PropertyPageBase.IPropertyStore.Initialize(object[] dataObject)
{
    // If we are editing multiple configuration at once, we may get multiple objects
    foreach (object data in dataObject)
    {
        if (data is IVsBrowseObject)
        {
            // get the Browse object…
            IVsBrowseObject browse = data as IVsBrowseObject;

            // Get the project item…
            IVsHierarchy project;
            uint count;
            browse.GetProjectItem(out project, out count);

            // now get/store the IMyCustomProperties object
            this.myCustomProperties = (IMyCustomProperties)project;
        }
        else
        {
            Debug.WriteLine(&quot;Not IVsBrowseObject&quot;);
        }
    }
}
</code></pre><p>This was the trick that allowed me to finish my implementation of the custom properties page, and to have data read
from the <code>.csproj</code> file, displayed in a custom properties tab, edited by the user, and then persisted to the <code>.csproj</code>
file.</p>
<p>I’ll eventually post a full sample, but in a follow-up post I’ll illustrate how I was able to read these properties in
my custom single file generator.</p><!--a(href='#{ conf.web_link }') Conference Homepage--><!--each session in conf.sessions--><!--  .row--><!--    .col-xs-11--><!--      h4 #{ session.title }--><!--      p #{ session.abstract }--><!--      if session.assets--><!--        ul--><!--          each asset in session.assets--><!--            li--><!--              a(href='#{ asset.link }') #{ asset.title }--></div></div><hr><div id="disqus_thread"></div></div></div></div><div class="col-sm-3"><div class="panel panel-default"><div class="panel-heading">Recent Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/fighting_with_hidden_characters">Fighting with Hidden Characters</a></li><li><a href="/technology/2014/you-cant-handle-the-truth">You Can't Handle The Truth</a></li><li><a href="/technology/2014/codestock-2014">CodeStock 2014</a></li><li><a href="/technology/2014/tracking-planes-on-vacation">Tracking Planes on Vacation</a></li><li><a href="/technology/2014/book-review-learning-windows-mobile-services-for-win-8-and-win-phone-8">Book Review: Learning Windows Mobile Services for Win 8 and Win Phone 8</a></li><li><a href="/technology/2014/codemash-2014">CodeMash 2014</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading">Older Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/">2015 Posts</a></li><li><a href="/technology/2014/">2014 Posts</a></li><li><a href="/technology/2013/">2013 Posts</a></li><li><a href="/technology/2012/">2012 Posts</a></li><li><a href="/technology/2011/">2011 Posts</a></li><li><a href="/technology/2010/">2010 Posts</a></li><li><a href="/technology/2009/">2009 Posts</a></li><li><a href="/technology/2008/">2008 Posts</a></li><li><a href="/technology/2007/">2007 Posts</a></li><li><a href="/technology/2006/">2006 Posts</a></li><li><a href="/technology/2005/">2005 Posts</a></li><li><a href="/technology/2004/">2004 Posts</a></li></ul></div></div></div></div></div></div><div id="footer"><div class="container"><p class="text-muted credit"><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a> This work is licensed under a<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"> Creative Commons Attribution 4.0 International License</a>.</p></div></div><script src="//use.typekit.net/lij0vky.js"></script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script><script type="text/javascript" src="/assets/site.js"></script></body></html>