<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Rob Gillen</title><link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"><!--link(rel="stylesheet", href='http://fonts.googleapis.com/css?family=Montserrat:400,700')--><!--link(rel="stylesheet", href='http://fonts.googleapis.com/css?family=PT+Sans:400,700')--><link rel="stylesheet" href="/assets/site.css"><link rel="stylesheet" href="/assets/academicons.css"></head><body><div id="wrap"><div class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Rob Gillen</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/technology">Technology</a></li><li><a href="/presentations">Talks</a></li><li><a href="/papers">Publications</a></li><li><a href="/projects">Projects</a></li><li><a href="/personal">Personal</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li><!--li.dropdown--><!--  a.dropdown-toggle(href="#", data-toggle="dropdown") Dropdown <b class="caret"></b>--><!--  ul.dropdown-menu--><!--    li--><!--      a(href="#") Action--><!--    li--><!--      a(href="#") Another action--><!--    li--><!--      a(href="#") Something else here--><!--    li.divider--><!--    li.dropdown-header Nav header--><!--    li--><!--      a(href="#") Separated link--><!--    li--><!--      a(href="#") One more separated link--></ul></div></div></div><div class="container"><div class="page-header"><h1 class="entry-title">Customizations to STSDev 1.3</h1></div><div class="row"><div class="col-md-9"><div class="panel"><div class="panel-body"><div class="row"><div class="col-md-12"><h5>June 23, 2009</h5><p>As part of my session on Deployment and build using TFS and SharePoint for <a href="http://www.codestock.org">CodeStock 09</a> I
took the source code from the STSDev project on CodePlex (<a href="http://stsdev.codeplex.com">http://stsdev.codeplex.com</a>) and made a number of
modifications. Some of these I would classify as clearly bugs, but most of them are simply adjustments to the core to
fit my needs/desires. I’m documenting them here and providing a zip of the source for the benefit of those attending
my session. These changes and source code are completely unsupported and you use them at your own risk. That being
said, I hope that they are helpful and speed you in your integration between SharePoint and TFS. NOTE: unless
specified, all of these changes are to the “Core” project.</p>
<ol>
<li><p>First minor change is that I moved the solution file up one level to the parent folder. This is truly nothing but a
nit-pick but seems to make source control trees happier and therefore something that I almost always do.</p>
</li>
<li><p>Upgraded the projects/solutions to Visual Studio 2008</p>
</li>
<li><p>Added an app.config file with an assembly binding redirect pushing old references to <code>Microsoft.Build.Framework</code> to
utilize version <code>3.5.0.0</code>. This is one of the changes needed to get support for .NET 3.5 working properly.</p>
</li>
<li><p>Changed the target framework property for the <code>stsdev.csproj</code> to .NET Framework 3.5. This change, in concert with
the previous, allows the 3.5 selection in the UI to work properly.</p>
</li>
<li><p><strong>Major Change</strong>: Support for alternate bin paths. The 1.3 version as published on CodePlex always uses the compiler
output in <code>projectdir\bin\debug</code> when assembling the *.wsp file. This happens regardless of what build configuration
you have selected (yes, even release). This doesn’t work for TFS builds since the output is, by default, in a different
location on the build server. To support this use case, the following changes were made:</p>
<ul>
<li><p><code>Program.cs</code>: Changes were made prior to calling <code>SolutionBuilder.RefreshDeploymentFiles</code> to support the passing in
of an additional parameter indicating the alternate bin path.</p>
</li>
<li><p>Changed the <code>Create</code> method of <code>Builders\DeploymentFiles\CabDdfBuilder.cs</code> to accept the <code>alternateBinPat</code> as an
additional parameter.</p>
</li>
<li><p>Changed the <code>Create</code> method of <code>Builders\DeploymentFiles\CabDdfBuilder.cs</code> such that, if an alternate bin path is
provided, it will use that value when adding references to assemblies rather than the otherwise-hard-coded
<code>/bin/debug/</code></p>
</li>
<li><p>Updated the first overload of the <code>RefreshDeploymentFiles</code> method in <code>SolutionBuilder.cs</code> to pass the alternate bin
path to the second overload of <code>RefreshDeploymentFiles</code>.</p>
</li>
<li><p>Updated the second overload of the <code>RefreshDeploymentFiles</code> method in <code>SolutionBuilder.cs</code> to build the <code>TargetPath</code>
from the <code>alternateBinPath</code> if provided and otherwise to use the default.</p>
</li>
<li><p>Updated the second overload of the <code>RefreshDeploymentFiles</code> method in <code>SolutionBuilder.cs</code> to pass the
<code>alternateBinPath</code> parameter to <code>CabDdfBuilder.Create()</code>.</p>
</li>
<li><p>Updated the <code>CompleteSolution</code> method in <code>SolutionBuilder.cs</code> to pass an empty value for <code>alternateBinPath</code> to
<code>RefreshDeploymentFiles</code> since, during the initial project creation, it is ok to utilize the default <code>/bin/debug</code>
path.</p>
</li>
</ul>
</li>
<li><p><strong>Major Change</strong>: When creating a project, always create a parent solution directory in the same way that Visual
Studio defaults to. This is helpful when working in a source controlled environment with multiple projects in the same
solution. To support this feature, the following changes were made:</p>
<ul>
<li><p>Changed the <code>&lt;REFRESH /&gt;</code> property in <code>Resources\Common\Microsoft.SharePoint.targets.xml</code> to utilize the
<code>$(ProjectDir)</code> variable rather than <code>$(SolutionDir)</code>.</p>
</li>
<li><p>Changed the <code>Create</code> method of <code>SolutionFiles\SolutionFileBuilder.cs</code> to accept the solution directory as an
additional parameter.</p>
</li>
<li><p>Changed the <code>Create</code> method of <code>SolutionFiles\SolutionFileBuilder.cs</code> to change the directory for where the
solution file is created</p>
</li>
<li><p>Changed the <code>Creat</code> method of <code>SolutionFiles\SolutionFileBuilder.cs</code> to reference the *.csproj file in
subdirectory rather than in the same directory as the *.sln file.</p>
</li>
<li><p>Added  a property called <code>ProjectDirectory</code> to <code>SolutionBuilder.cs</code> to hold the full path to the project directory
(now distinguished from <code>SolutionDirectory</code>).</p>
</li>
<li><p>Updated the <code>RunCreateSolutionWizard</code> method in <code>SolutionBuilder.cs</code> to set the Project Directory property.</p>
</li>
<li><p>Updated the <code>InitializeSolution</code> method of <code>SolutionBuilder.cs</code> to create the new (child) project directory and
update the location appropriately</p>
</li>
<li><p>Updated the <code>InitializeSolution</code> method of <code>SolutionBuilder.cs</code> to set the <code>SolutionBuilder.TargetPath</code> based on the
<code>ProjectDirectory</code> property rather than the <code>SolutionDirectory</code> value.</p>
</li>
<li><p>Updated the <code>CreateDeploymentFiles</code> method of <code>SolutionBuilder.cs</code> to use the proper path for the files (based on
<code>ProjectDirectory</code>).</p>
</li>
<li><p>Updated the <code>RefreshDeploymentFiles()</code> (first overload) method of <code>SolutionBuilder.cs</code> to optionally set the
<code>ProjectDirectory</code> property if it isn’t already set.</p>
</li>
<li><p>Updated the second overload of the <code>RefreshDeploymentFiles</code> method of <code>SolutionBuilder.cs</code> to set the current
directory to the value of <code>ProjectDirectory</code> if it is set, and otherwise to use the <code>SolutionDirectory</code> value.</p>
</li>
<li><p>Updated the second overload of the <code>RefreshDeploymentFiles</code> method of <code>SolutionBuilder.cs</code> to utilize the
<code>ProjectDirectory</code> value rather than the <code>SolutionDirectory</code> path.</p>
</li>
<li><p>Updated the <code>LoadSolutionConfigFile</code> method in <code>SolutionBuilder.cs</code> to use the <code>ProjectDirectory</code> property and
remove the pathing ambiguity that was leading to incorrect path lookups.</p>
</li>
<li><p>Updated the <code>CompleteSolution</code> method in <code>SolutionBuilder.cs</code> to pass the <code>SolutionDirectory</code> property to
<code>SolutionFileBuilder.Create()</code> since it can no longer assume that the solution file should be in the same directory
as the project file.</p>
</li>
</ul>
</li>
<li><p><strong>Major Change</strong>: Added support for the <code>Release|AnyCPU</code> project configuration to support integration with TFS Build.
In support of this feature, the following changes were made:</p>
<ul>
<li><p>Added <code>&lt;REFRESH-TEAMBUILD&gt;</code> property in <code>Resources\Common\Microsoft.SharePoint.targets.xml</code> file. The value of this
property is similar to that of <code>&lt;REFRESH /&gt;</code> but has an additional parameter referencing the alternate bin path that
TFS creates by default.</p>
</li>
<li><p>Added a <code>Release</code> target in <code>Resources\Common\Microsoft.SharePoint.targets.xml</code>. This is targeted specifically at the
TFS build and is therefore similar to the <code>ReleaseBuild</code> target but calls the <code>$(REFRESH-TEAMBUILD)</code> exe rather than
<code>$(REFRESH)</code></p>
</li>
<li><p>Added a “Release” value to the Configurations string array in <code>SolutionBuilder.cs</code>. This causes the release config
to be added to the generated solution and project files.</p>
</li>
</ul>
</li>
<li><p><strong>Major Change</strong>: We utilize SharePoint Installer to create a nicely-packaged version of the resulting solution
making it nearly brain-dead easy to install a new solution. The only real thing unique or project-specific in a
SharePoint Installer package is the <code>setup.exe.config</code> file that passes a number of parameters to the executable
allowing it to adapt for your particular solution package. This feature change causes STSDev to generate the initial
draft of this file and to add it to the solution items. To this end, the following changes were made:</p>
<ul>
<li><p>Created a new file, <code>SolutionFiles\SetupConfigFileBuilder.cs</code> to represent the template and logic for the
<code>SetupConfigFileBuilder</code> class.</p>
</li>
<li><p>Updated the <code>CompleteSolution</code> method in <code>SolutionBuilder.cs</code> to call <code>SetupConfigFileBuilder.Create</code> and create
the new config file.</p>
</li>
<li><p>Updated <code>SolutionFiles\SolutionFileBuilder.cs</code> to include a pointer to <code>setup.exe.config</code> and thereby include it in
the solution.</p>
</li>
</ul>
</li>
<li><p><strong>Major Change</strong>: We utilize Sand Castle and Sand Castle Help File Builder to produce developer-targeted API
documents for our projects. Sand Castle Help File Builder needs a configuration file (xml) with a number of property
values to configure it to run properly. This feature allows the basic file to be generated by STSDev and for it to be
added to the solution items collection. To this end, the following changes were made:</p>
<ul>
<li><p>Created a new file, <code>SolutionFiles\SandcastleHelpFileBuilder.cs</code> to represent the template and logic for the
<code>SandcastleHelpFileBuilder</code> class.</p>
</li>
<li><p>Updated the <code>CompleteSolution</code> method in <code>SolutionBuilder.cs</code> to call <code>SandcastleHelpFileBuilder.Create</code> and create
the configuration file.</p>
</li>
<li><p>Updated <code>SolutionFiles\SolutionFileBuilder.cs</code> to include a pointer to the generated *.shfb file and thereby
include it in the solution.</p>
</li>
</ul>
</li>
<li><p><strong>Major Change</strong>: By default, STSDev would not only generate <code>manifest.xml</code> and the ddf file, but it would add
these files to the project. While in many cases this is innocous, it causes heartburn in a source-controlled
environment. Firstly, purely generated files have no business being in your source tree. Secondly, since the user
doesn’t edit them, once they are checked in, they are most often left as such, resulting in errors on compile because
the files are marked as read only, preventing stsdev.exe from updating them properly. To this end, the
<code>CreateDeploymentFiles</code> method of <code>SolutionBuilder.cs</code> has been updated to remove the calls to
<code>ProjectBuilder.AddSourceFile()</code> following <code>ManifestBuilder.Create()</code> and <code>CabDdfBuilder.Create()</code>.</p>
</li>
<li><p>Added an image, <code>PlanetIcon.gif</code> to the resources section and replaced all hard-coded references to
<code>africanpith.jpg</code> with references to <code>PlanetIcon.gif</code>. This is nothing more than a branding change for the output
projects and has no other affect on the program’s functionality. Affected files include: <code>stsdev.csproj</code>,
<code>SolutionProviders\SimpleFeatureSolutionProvider.cs</code> (<code>AddSolutionItems</code> method),
<code>Builders\SourceFiles\FeatureBuilder.cs</code> (<code>Create</code> method)</p>
</li>
<li><p>Adjusted the <code>InitilaizeSolutionProviders</code> method of <code>UserInterface\SelectSolutionType.cs</code> to select by default the
Web Part Solution (C# Assembly) project type on load rather than the empty solution. This change is nothing other than
a convenience feature during testing and use (that’s almost always the project type I use).</p>
</li>
<li><p>Adjusted the <code>RefreshDeploymentFiles</code> method of <code>SolutionBuilder.cs</code> to fix some seemingly obvious bugs in Console
output using incorrect values.</p>
</li>
</ol>
<p>Following the session on Friday, I’ll update this post with the actual source code and any other changes made during
the presentation.</p><!--a(href='#{ conf.web_link }') Conference Homepage--><!--each session in conf.sessions--><!--  .row--><!--    .col-xs-11--><!--      h4 #{ session.title }--><!--      p #{ session.abstract }--><!--      if session.assets--><!--        ul--><!--          each asset in session.assets--><!--            li--><!--              a(href='#{ asset.link }') #{ asset.title }--></div></div><hr><div id="disqus_thread"></div></div></div></div><div class="col-sm-3"><div class="panel panel-default"><div class="panel-heading">Recent Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/fighting_with_hidden_characters">Fighting with Hidden Characters</a></li><li><a href="/technology/2014/you-cant-handle-the-truth">You Can't Handle The Truth</a></li><li><a href="/technology/2014/codestock-2014">CodeStock 2014</a></li><li><a href="/technology/2014/tracking-planes-on-vacation">Tracking Planes on Vacation</a></li><li><a href="/technology/2014/book-review-learning-windows-mobile-services-for-win-8-and-win-phone-8">Book Review: Learning Windows Mobile Services for Win 8 and Win Phone 8</a></li><li><a href="/technology/2014/codemash-2014">CodeMash 2014</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading">Older Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/">2015 Posts</a></li><li><a href="/technology/2014/">2014 Posts</a></li><li><a href="/technology/2013/">2013 Posts</a></li><li><a href="/technology/2012/">2012 Posts</a></li><li><a href="/technology/2011/">2011 Posts</a></li><li><a href="/technology/2010/">2010 Posts</a></li><li><a href="/technology/2009/">2009 Posts</a></li><li><a href="/technology/2008/">2008 Posts</a></li><li><a href="/technology/2007/">2007 Posts</a></li><li><a href="/technology/2006/">2006 Posts</a></li><li><a href="/technology/2005/">2005 Posts</a></li><li><a href="/technology/2004/">2004 Posts</a></li></ul></div></div></div></div></div></div><div id="footer"><div class="container"><p class="text-muted credit"><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a> This work is licensed under a<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"> Creative Commons Attribution 4.0 International License</a>.</p></div></div><script src="//use.typekit.net/lij0vky.js"></script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script><script type="text/javascript" src="/assets/site.js"></script></body></html>