<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Rob Gillen</title><link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"><!--link(rel="stylesheet", href='http://fonts.googleapis.com/css?family=Montserrat:400,700')--><!--link(rel="stylesheet", href='http://fonts.googleapis.com/css?family=PT+Sans:400,700')--><link rel="stylesheet" href="/assets/site.css"><link rel="stylesheet" href="/assets/academicons.css"></head><body><div id="wrap"><div class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Rob Gillen</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/technology">Technology</a></li><li><a href="/presentations">Talks</a></li><li><a href="/papers">Publications</a></li><li><a href="/projects">Projects</a></li><li><a href="/personal">Personal</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li><!--li.dropdown--><!--  a.dropdown-toggle(href="#", data-toggle="dropdown") Dropdown <b class="caret"></b>--><!--  ul.dropdown-menu--><!--    li--><!--      a(href="#") Action--><!--    li--><!--      a(href="#") Another action--><!--    li--><!--      a(href="#") Something else here--><!--    li.divider--><!--    li.dropdown-header Nav header--><!--    li--><!--      a(href="#") Separated link--><!--    li--><!--      a(href="#") One more separated link--></ul></div></div></div><div class="container"><div class="page-header"><h1 class="entry-title">Azure Blob Storage Blob IDs and “+”</h1></div><div class="row"><div class="col-md-9"><div class="panel"><div class="panel-body"><div class="row"><div class="col-md-12"><h5>July 30, 2009</h5><p>I’ve been kicking the tires on Azure’s blob storage and am working on uploading a 1.2GB+ NetCDF file. I stumbled across
a couple of <a href="http://azuredba.com/Blog/tabid/621/EntryId/183/A-REST-ful-Look-at-Azure-Blob-Storage-continued.aspx">samples online</a>
that were very helpful in avoiding the de facto client library that ships with the SDK however I found myself bit by
something (likely due to my error somehow) that I thought I’d pass along.</p>
<p>When processing a larger file, my upload process would always fail at block #248. At first, I assumed it was a network
transience issue and simply re-ran the upload, however, after having it fail on the exact same block 3 times, I decided
that it wasn’t the network. In digging a bit into things, I found that the problem had to do with the encoding of the
block IDs. The offending piece of code is here:</p>
<pre><code>for (int i = 0; i &lt; blocksCount; i++)
{
    blockIds[i] = Convert.ToBase64String(BitConverter.GetBytes(i));
</code></pre><p>Where <code>i</code> is an integer representing the index of the current block within the file and <code>blockIds</code> is an array of IDs
used to build the block ID list as part of a <code>putBlockList</code> operation.</p>
<p>The Azure SDK would indicate that this code snippet is perfectly valid… block IDs need to be a base 64-encoded string
uniquely identifying the block within the blob. Further, each ID (within a blob) must be of the same length prior to
encoding (same number of bytes). In this scenario, <code>BitConverter.GetBytes</code> returns a 4-byte array of values for all
numbers within the range (in my case, 0 – 314). The following is an example of the resulting string for some numbers:</p>
<ul>
<li><code>246: 9gAAAA==</code></li>
<li><code>247: 9wAAAA==</code></li>
<li><code>248: +AAAAA==</code></li>
</ul>
<p>There continues about 4 that begin with a ‘+’ sign, and a similar number that begin with ‘\’. Every other index in my
collection began with a normal alpha character. After doing some poking around I found some indications that others
were having similar problems and went down the path of encoding the line differently (i.e.
<code>HttpServerUtility.UrlTokenEncode</code>, etc) to no avail. What I ended up with is simply prefixing my values with a
standard “safe” string (“BlockId”)</p>
<pre><code>for (int i = 0; i &lt; blocksCount; i++)
{
    blockIds[i] = Convert.ToBase64String(
        ASCIIEncoding.ASCII.GetBytes(
        string.Format(&quot;BlockId{0}&quot;, i.ToString(&quot;000&quot;))));
</code></pre><p>This yielded a blockId that was unique, consistent length (notice the formatting of the indexer in the <code>ToString()</code>
method), and “safe” in that it always began with a URL-safe character.</p>
<p>I’m certain that there is likely a better way to solve this problem, but this did the trick for me and maybe it will
be helpful to someone else.</p><!--a(href='#{ conf.web_link }') Conference Homepage--><!--each session in conf.sessions--><!--  .row--><!--    .col-xs-11--><!--      h4 #{ session.title }--><!--      p #{ session.abstract }--><!--      if session.assets--><!--        ul--><!--          each asset in session.assets--><!--            li--><!--              a(href='#{ asset.link }') #{ asset.title }--></div></div><hr><div id="disqus_thread"></div></div></div></div><div class="col-sm-3"><div class="panel panel-default"><div class="panel-heading">Recent Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/fighting_with_hidden_characters">Fighting with Hidden Characters</a></li><li><a href="/technology/2014/you-cant-handle-the-truth">You Can't Handle The Truth</a></li><li><a href="/technology/2014/codestock-2014">CodeStock 2014</a></li><li><a href="/technology/2014/tracking-planes-on-vacation">Tracking Planes on Vacation</a></li><li><a href="/technology/2014/book-review-learning-windows-mobile-services-for-win-8-and-win-phone-8">Book Review: Learning Windows Mobile Services for Win 8 and Win Phone 8</a></li><li><a href="/technology/2014/codemash-2014">CodeMash 2014</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading">Older Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/">2015 Posts</a></li><li><a href="/technology/2014/">2014 Posts</a></li><li><a href="/technology/2013/">2013 Posts</a></li><li><a href="/technology/2012/">2012 Posts</a></li><li><a href="/technology/2011/">2011 Posts</a></li><li><a href="/technology/2010/">2010 Posts</a></li><li><a href="/technology/2009/">2009 Posts</a></li><li><a href="/technology/2008/">2008 Posts</a></li><li><a href="/technology/2007/">2007 Posts</a></li><li><a href="/technology/2006/">2006 Posts</a></li><li><a href="/technology/2005/">2005 Posts</a></li><li><a href="/technology/2004/">2004 Posts</a></li></ul></div></div></div></div></div></div><div id="footer"><div class="container"><p class="text-muted credit"><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a> This work is licensed under a<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"> Creative Commons Attribution 4.0 International License</a>.</p></div></div><script src="//use.typekit.net/lij0vky.js"></script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script><script type="text/javascript" src="/assets/site.js"></script></body></html>