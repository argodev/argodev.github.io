<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Rob Gillen</title><link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"><!--link(rel="stylesheet", href='http://fonts.googleapis.com/css?family=Montserrat:400,700')--><!--link(rel="stylesheet", href='http://fonts.googleapis.com/css?family=PT+Sans:400,700')--><link rel="stylesheet" href="/assets/site.css"><link rel="stylesheet" href="/assets/academicons.css"></head><body><div id="wrap"><div class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Rob Gillen</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/technology">Technology</a></li><li><a href="/presentations">Talks</a></li><li><a href="/papers">Publications</a></li><li><a href="/projects">Projects</a></li><li><a href="/personal">Personal</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li><!--li.dropdown--><!--  a.dropdown-toggle(href="#", data-toggle="dropdown") Dropdown <b class="caret"></b>--><!--  ul.dropdown-menu--><!--    li--><!--      a(href="#") Action--><!--    li--><!--      a(href="#") Another action--><!--    li--><!--      a(href="#") Something else here--><!--    li.divider--><!--    li.dropdown-header Nav header--><!--    li--><!--      a(href="#") Separated link--><!--    li--><!--      a(href="#") One more separated link--></ul></div></div></div><div class="container"><div class="page-header"><h1 class="entry-title">Silverlight and Azure Table Data Paging</h1></div><div class="row"><div class="col-md-9"><div class="panel"><div class="panel-body"><div class="row"><div class="col-md-12"><h5>August 5, 2009</h5><p>I’m <a href="/technology/2009/azure-visualization-and-large-datasets">playing around</a> with a data visualization
app using Silverlight and data hosted in Azure Tables and have been learning quite a bit in the process. Firstly,
Azure tables only allows you to return 1000 records in a given query. If you issue a query that has a larger matching
result set, Azure will return some extra headers indicating as such (<code>x-ms-continuation-NextPartitionKey</code> and
<code>x-ms-continuation-NextRowKey</code>). It wasn’t hard to find [an example of data paging using Azure table data]
(<a href="http://msdn.microsoft.com/en-us/library/dd135718.aspx">http://msdn.microsoft.com/en-us/library/dd135718.aspx</a>), however it used the <code>Execute()</code> method of the
<code>DataServiceQuery</code> object. Unfortunately, this isn’t available in Silverlight as you have to use the asynchronous
methods (<code>BeginQuery</code> and <code>EndQuery</code>). I’m a bit slow, and for whatever reason translating the MSDN sample for
synchronous to the asynchronous model took me longer than it should have. I’m posting this so that maybe the next
person will find this, get the answer they need, and move on and not waste the same amount of time I did.</p>
<p>My button event handler looks quite a bit different from the MSDN sample but is pretty easy to figure out:</p>
<pre><code>// get a collection of points from the data service
var context = new data1DataServiceContext();

var tempSet = context
    .CreateQuery&lt;TemperatureValue&gt;(&quot;TemperatureValue&quot;)
    .Where(tv =&gt; (tv.time == selectedTime) &amp;&amp;
        (tv.PartitionKey == selectedTime.ToString()));

var query = tempSet as DataServiceQuery&lt;TemperatureValue&gt;;

// begin the call and grab the first set of data
query.BeginExecute(
    new AsyncCallback(this.ProcessDataResponse), query);
</code></pre><p>I instantiate the context, create a query based on that context, cast that query as a <code>DataServiceQuery&lt;t&gt;</code> and then
call the <code>BeginExecute</code> method passing my callback method and the query as my state object. (Note: in case you are
wondering about the <code>Where</code> clause in the query above, I know that all of the data that matches the first conditional
is located in a given partition within the Azure table and have found that specifying the partition greatly increases
the performance).</p>
<p>My callback method (<code>ProcessDataRequest</code>) does a bit of recursion to support the unknown number of subsequent calls
needed to retrieve all of the matching records.</p>
<p>The contents of the <code>ProcessDataRequest</code> method are listed below:</p>
<pre><code>var query = ar.AsyncState as DataServiceQuery&lt;TemperatureValue&gt;;
var response = query.EndExecute(ar) as QueryOperationResponse;

// add the points to the screen
this.AddPointsToScreen(response);

// see if there are more entries waiting
if (response.Headers.ContainsKey(&quot;x-ms-continuation-NextPartitionKey&quot;))
{
    // get a collection of points from the data service
    var context = new data1DataServiceContext();

    var tempSet = context
        .CreateQuery&lt;TemperatureValue&gt;(&quot;TemperatureValue&quot;)
        .Where(tv =&gt; (tv.time == selectedTime) &amp;&amp;
            (tv.PartitionKey == selectedTime.ToString()));

    var newQuery = tempSet as DataServiceQuery&lt;TemperatureValue&gt;;

    newQuery = newQuery.AddQueryOption(&quot;NextPartitionKey&quot;,
        response.Headers[&quot;x-ms-continuation-NextPartitionKey&quot;]);

    if (response.Headers.ContainsKey(&quot;x-ms-continuation-NextRowKey&quot;))
    {
        newQuery = newQuery.AddQueryOption(&quot;NextRowKey&quot;,
            response.Headers[&quot;x-ms-continuation-NextRowKey&quot;]);
    }

    // Ok, now we need to execute it again
    newQuery.BeginExecute(
        new AsyncCallback(this.ProcessDataResponse), newQuery);
}
</code></pre><p>Note that unlike some samples that are simply focusing on async data calls and don’t handle paging via headers, I cast
the output of <code>EndExecute</code> as a <code>QueryOperationResponse</code> object which allows me to subsequently access the headers and
interrogate them for the continuation keys. If I find the continuation keys, I create a new query object, set the
additional query options, and execute it in the same fashion as the original call.  The <code>AddPointsToScreen</code> method
simply processes the values and renders them as polygons to the screen. I’ve included it here not because there is
anything special in it, but rather for completeness.</p>
<pre><code>private void AddPointsToScreen(QueryOperationResponse response)
{
    foreach (TemperatureValue tv in response)
    {
        double boxSize = 1.45;

        // add to map
        MapPolygon polygon = new MapPolygon();
        polygon.Fill = new SolidColorBrush(HexStringToColor
            (TempToColorString(Convert.ToInt32(tv.tas - 210))));
        polygon.Opacity = 0.6;
        polygon.Locations = new LocationCollection() {
            new Location(tv.lat + boxSize, tv.lon - boxSize),
            new Location(tv.lat + boxSize, tv.lon + boxSize),
            new Location(tv.lat - boxSize, tv.lon + boxSize),
            new Location(tv.lat - boxSize, tv.lon - boxSize)
        };

        polygon.IsHitTestVisible = false;

        TestMap.AddChild(polygon);
    }
}
</code></pre><!--a(href='#{ conf.web_link }') Conference Homepage--><!--each session in conf.sessions--><!--  .row--><!--    .col-xs-11--><!--      h4 #{ session.title }--><!--      p #{ session.abstract }--><!--      if session.assets--><!--        ul--><!--          each asset in session.assets--><!--            li--><!--              a(href='#{ asset.link }') #{ asset.title }--></div></div><hr><div id="disqus_thread"></div></div></div></div><div class="col-sm-3"><div class="panel panel-default"><div class="panel-heading">Recent Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/fighting_with_hidden_characters">Fighting with Hidden Characters</a></li><li><a href="/technology/2014/you-cant-handle-the-truth">You Can't Handle The Truth</a></li><li><a href="/technology/2014/codestock-2014">CodeStock 2014</a></li><li><a href="/technology/2014/tracking-planes-on-vacation">Tracking Planes on Vacation</a></li><li><a href="/technology/2014/book-review-learning-windows-mobile-services-for-win-8-and-win-phone-8">Book Review: Learning Windows Mobile Services for Win 8 and Win Phone 8</a></li><li><a href="/technology/2014/codemash-2014">CodeMash 2014</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading">Older Posts</div><div class="panel-body"><ul><li><a href="/technology/2015/">2015 Posts</a></li><li><a href="/technology/2014/">2014 Posts</a></li><li><a href="/technology/2013/">2013 Posts</a></li><li><a href="/technology/2012/">2012 Posts</a></li><li><a href="/technology/2011/">2011 Posts</a></li><li><a href="/technology/2010/">2010 Posts</a></li><li><a href="/technology/2009/">2009 Posts</a></li><li><a href="/technology/2008/">2008 Posts</a></li><li><a href="/technology/2007/">2007 Posts</a></li><li><a href="/technology/2006/">2006 Posts</a></li><li><a href="/technology/2005/">2005 Posts</a></li><li><a href="/technology/2004/">2004 Posts</a></li></ul></div></div></div></div></div></div><div id="footer"><div class="container"><p class="text-muted credit"><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a> This work is licensed under a<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"> Creative Commons Attribution 4.0 International License</a>.</p></div></div><script src="//use.typekit.net/lij0vky.js"></script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script><script type="text/javascript" src="/assets/site.js"></script></body></html>